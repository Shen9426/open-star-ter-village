<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
    // The code in this function runs when the page is loaded.
    $(document).ready(function () {
      google.script.run
        .withSuccessHandler(showCards)
        .withFailureHandler(showError)
        .getPlayerCards();
      $('#play-project-card').click(playProjectCard);
    });

    function showProjectCards(projectCards) {
      const list = $('#project-cards');
      list.empty();
      for (var i = 0; i < projectCards.length; i++) {
        const id = `prj-${i}`;
        const dom = `<div>
            <input type="checkbox" id="${id}" class="card card-project" name="project-cards" value="${projectCards[i]}" />
            <label for="${id}">${projectCards[i]}</label>
          </div>`;
        list.append(dom);
      }
    }
    function showResourceCards(resourceCards) {
      const list = $('#resource-cards');
      list.empty();
      for (var i = 0; i < resourceCards.length; i++) {
        const id = `res-${i}`;
        const dom = `<div>
            <input type="checkbox" id="${id}" class="card card-resource" name="resource-cards" value="${resourceCards[i]}" />
            <label for="${id}">${resourceCards[i]}</label>
          </div>`;
        list.append(dom);
      }
    }

    function showCards(hand) {
      showProjectCards(hand.projectCards);
      showResourceCards(hand.resourceCards);
    }

    function showError(msg, element) {
      const div = $(`<div id="error" class="error">${msg}</div>`);
      $(element).after(div);
    }
    function removeError() {
      $('#error').remove();
    }

    function playProjectCard() {
      removeError();
      // disable the button
      this.disabled = true;
      const selectedProjectCards = $('input[name="project-cards"]:checked').map(function () {
        return $(this).val();
      }).get();
      if (selectedProjectCards.length !== 1) {
        showError('請選擇一張專案卡', this);
        this.disabled = false;
        return;
      }
      google.script.run
        .withSuccessHandler(
          function (projectCards, element) {
            showProjectCards(projectCards);
            element.disabled = false;
          })
        .withFailureHandler(
          function (error, element) {
            showError(error, element);
            element.disabled = false;
          })
        .withUserObject(this)
        .playProjectCard(selectedProjectCards[0]);
    }
  </script>
</head>

<body>
  <div class="sidebar">
    <h1>
      <?= player ?>的手牌
    </h1>
    <form>
      <h2>專案卡</h2>
      <div id="project-cards" class="form-group">Loading...</div>
      <h2>資源卡</h2>
      <div id="resource-cards" class="form-group">Loading...</div>
      <h3>Actions</h3>
      <div><button id="play-project-card" class="action">play project card</button></div>
      <div><button id="play-resouce-card" class="action">play resource card</button></div>
      <div><button id="discard-card">discard card and end turn</button></div>
    </form>
  </div>
</body>

</html>
