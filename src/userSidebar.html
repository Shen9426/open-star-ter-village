<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
    // The code in this function runs when the page is loaded.
    $(document).ready(function () {
      google.script.run
        .withSuccessHandler(showCards)
        .withFailureHandler(showError)
        .getPlayerCards();
      $('#play-project-card').click(playProjectCard);

      $('#menu__place-resource-card-on-project').click(menuPlaceResourceCardOnProject);
      $('#menu__play-project-card').click(menuPlayProjectCard);
      $('#menu__contribute-project').click(menuContributeProject);
      $('#menu__play-resource-card').click(menuPlayResourceCard);
      $('#menu__discard-and-end-turn').click(menuDiscardAndEndTurn);
      $('#menu__return').click(menuReturn);
    });

    function showProjectCards(projectCards) {
      const list = $('#project-cards');
      list.empty();
      for (var i = 0; i < projectCards.length; i++) {
        const id = `prj-${i}`;
        const dom = `<li id="${id}" name="project-cards">${projectCards[i]}</li>`;
        list.append(dom);
      }
    }
    function showResourceCards(resourceCards) {
      const list = $('#resource-cards');
      list.empty();
      for (var i = 0; i < resourceCards.length; i++) {
        const id = `res-${i}`;
        const dom = `<li id="${id}" name="resource-cards">${resourceCards[i]}</li>`;
        list.append(dom);
      }
    }

    function showCards(hand) {
      showProjectCards(hand.projectCards);
      showResourceCards(hand.resourceCards);
    }

    function showError(msg, element) {
      const div = $(`<div id="error" class="error">${msg}</div>`);
      $(element).after(div);
    }
    function removeError() {
      $('#error').remove();
    }

    const renderProjectCardRadio = () => {
      $('li[name="project-cards"]').each(function (idx) {
        const projectCard = $(this).text();
        const id = `prj-${idx}`;
        const dom = `<div>
            <input type="radio" id="${id}" class="card card-project" name="project-cards" value="${projectCard}" />
            <label for="${id}">${projectCard}</label>
          </div>`;
        $(this).replaceWith(dom);
      });
    };

    const renderResourceCardRadio = () => {
      $('li[name="resource-cards"]').each(function (idx) {
        const resourceCard = $(this).text();
        const id = `res-${idx}`;
        const dom = `<div>
            <input type="radio" id="${id}" class="card card-resource" name="resource-cards" value="${resourceCard}" />
            <label for="${id}">${resourceCard}</label>
          </div>`;
        $(this).replaceWith(dom);
      });
    };

    const renderProjectCardCheckbox = () => {
      $('li[name="project-cards"]').each(function (idx) {
        const projectCard = $(this).text();
        const id = `prj-${idx}`;
        const dom = `<div>
            <input type="checkbox" id="${id}" class="card card-project" name="project-cards" value="${projectCard}" />
            <label for="${id}">${projectCard}</label>
          </div>`;
        $(this).replaceWith(dom);
      });
    };

    const renderResourceCardCheckbox = () => {
      $('li[name="resource-cards"]').each(function (idx) {
        const resourceCard = $(this).text();
        const id = `res-${idx}`;
        const dom = `<div>
            <input type="checkbox" id="${id}" class="card card-resource" name="resource-cards" value="${resourceCard}" />
            <label for="${id}">${resourceCard}</label>
          </div>`;
        $(this).replaceWith(dom);
      });
    };

    const renderProjectCardStatic = () => {
      $('input[name="project-cards"]').each(function (idx) {
        const projectCard = $(this).val();
        const id = `prj-${idx}`;
        const dom = `<li id="${id}" name="project-cards">${projectCard}</li>`;
        $(this).parent().replaceWith(dom);
      });
    };

    const renderResourceCardStatic = () => {
      $('input[name="resource-cards"]').each(function (idx) {
        const resourceCard = $(this).val();
        const id = `res-${idx}`;
        const dom = `<li id="${id}" name="resource-cards">${resourceCard}</li>`;
        $(this).parent().replaceWith(dom);
      });
    };

    const disableMenu = () => {
      $('#menu__place-resource-card-on-project').prop('disabled', true);
      $('#menu__play-project-card').prop('disabled', true);
      $('#menu__contribute-project').prop('disabled', true);
      $('#menu__play-resource-card').prop('disabled', true);
      $('#menu__discard-and-end-turn').prop('disabled', true);
      $('#menu__return').prop('disabled', false);
    };

    const enableMenu = () => {
      $('#menu__place-resource-card-on-project').prop('disabled', false).removeClass('action');
      $('#menu__play-project-card').prop('disabled', false).removeClass('action');
      $('#menu__contribute-project').prop('disabled', false).removeClass('action');
      $('#menu__play-resource-card').prop('disabled', false).removeClass('action');
      $('#menu__discard-and-end-turn').prop('disabled', false).removeClass('action');
      $('#menu__return').prop('disabled', true);
    };

    function menuPlaceResourceCardOnProject() {
      disableMenu();
      $(this).addClass('action');

      renderProjectCardStatic();
      renderResourceCardRadio();
    }

    function menuPlayProjectCard() {
      disableMenu();
      $(this).addClass('action');

      renderProjectCardRadio();
      renderResourceCardRadio();
    }

    function menuContributeProject() {
      disableMenu();
      $(this).addClass('action');

      renderProjectCardStatic();
      renderResourceCardStatic();
    }

    function menuPlayResourceCard() {
      disableMenu();
      $(this).addClass('action');

      renderProjectCardStatic();
      renderResourceCardRadio();
    }

    function menuDiscardAndEndTurn() {
      disableMenu();
      $(this).addClass('action');

      renderProjectCardCheckbox();
      renderResourceCardCheckbox();
    }

    function menuReturn() {
      enableMenu();

      renderProjectCardStatic();
      renderResourceCardStatic();
    }

    function playProjectCard() {
      removeError();
      // disable the button
      this.disabled = true;
      const selectedProjectCard = $('input[name="project-cards"]:checked').val();
      const selectedResourceCard = $('input[name="resource-cards"]:checked').val();
      google.script.run
        .withSuccessHandler(
          function (projectCards, element) {
            showProjectCards(projectCards);
            element.disabled = false;
          })
        .withFailureHandler(
          function (error, element) {
            showError(error, element);
            element.disabled = false;
          })
        .withUserObject(this)
        .playProjectCard(selectedProjectCard, selectedResourceCard);
    }
  </script>
</head>

<body>
  <div class="sidebar">
    <h1>
      <?= player ?>的手牌
    </h1>
    <div>
      <button id="menu__place-resource-card-on-project">招募人力<span>(1)</span></button>
      <button id="menu__play-project-card">發起專案<span>(2)</span></button>
      <button id="menu__contribute-project">貢獻專案<span>(1)</span></button>
    </div>
    <div>
      <button id="menu__play-resource-card">源力加持<span>(1)</span></button>
      <button id="menu__discard-and-end-turn">棄牌後結束回合</button>
      <button id="menu__return" disabled>返回選單</button>
    </div>
    <form>
      <h2>專案卡</h2>
      <ul id="project-cards" class="form-group">Loading...</ul>
      <h2>資源卡</h2>
      <ul id="resource-cards" class="form-group">Loading...</ul>
      <h3>Actions</h3>
      <div><button id="play-project-card" class="action">play project card</button></div>
      <div><button id="play-resouce-card" class="action">play resource card</button></div>
      <div><button id="discard-card">discard card and end turn</button></div>
    </form>
  </div>
</body>

</html>
