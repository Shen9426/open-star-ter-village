<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>
    // The code in this function runs when the page is loaded.
    $(document).ready(function () {
      google.script.run
        .withSuccessHandler(showCards)
        .withFailureHandler(showError)
        .getPlayerCards();

      $('#menu__recruit').click(menuRecruit);
      $('#menu__create-project').click(menuCreateProject);
      $('#menu__contribute-project').click(menuContributeProject);
      $('#menu__play-force-card').click(menuPlayForceCard);
      $('#menu__discard-and-end-turn').click(menuDiscardAndEndTurn);
    });

    function showProjectCards(projectCards) {
      const list = $('#project-cards');
      list.empty();
      for (var i = 0; i < projectCards.length; i++) {
        const id = `prj-${i}`;
        const dom = `<li id="${id}" name="project-cards">${projectCards[i]}</li>`;
        list.append(dom);
      }
    }
    function showResourceCards(resourceCards) {
      const list = $('#resource-cards');
      list.empty();
      for (var i = 0; i < resourceCards.length; i++) {
        const id = `res-${i}`;
        const dom = `<li id="${id}" name="resource-cards">${resourceCards[i]}</li>`;
        list.append(dom);
      }
    }

    function showCards(hand) {
      showProjectCards(hand.projectCards);
      showResourceCards(hand.resourceCards);
    }

    function setActionBar(elements) {
      $('#action-bar').empty();
      $('#action-bar').append(elements);
    };

    function clearActionBar() {
      $('#action-bar').empty();
    };

    function showMessage(msg, element) {
      const span = $(`<span id="message" class="gray">${msg}</span>`);
      $(element).after(span);
    }
    function removeMessage() {
      $('#message').remove();
    }
    function showError(msg, element) {
      const div = $(`<div id="error" class="error">${msg}</div>`);
      $(element).after(div);
    }
    function removeError() {
      $('#error').remove();
    }

    const renderProjectCardRadio = () => {
      // replace from static list
      $('li[name="project-cards"]').each(function (idx) {
        const projectCard = $(this).text();
        const id = `prj-${idx}`;
        const dom = `<div>
            <input type="radio" id="${id}" class="card card-project" name="project-cards" value="${projectCard}" />
            <label for="${id}">${projectCard}</label>
          </div>`;
        $(this).replaceWith(dom);
      });

      // replace from checkbox
      $('input[name="project-cards"][type="checkbox"]').each(function (idx) {
        const projectCard = $(this).val();
        const id = `prj-${idx}`;
        const dom = `<input type="radio" id="${id}" class="card card-project" name="project-cards" value="${projectCard}">`;
        $(this).replaceWith(dom);
      });
    };

    const renderResourceCardRadio = () => {
      // replace from static list
      $('li[name="resource-cards"]').each(function (idx) {
        const resourceCard = $(this).text();
        const id = `res-${idx}`;
        const dom = `<div>
            <input type="radio" id="${id}" class="card card-resource" name="resource-cards" value="${resourceCard}" />
            <label for="${id}">${resourceCard}</label>
          </div>`;
        $(this).replaceWith(dom);
      });

      // replace from checkbox
      $('input[name="resource-cards"][type="checkbox"]').each(function (idx) {
        const resourceCard = $(this).val();
        const id = `res-${idx}`;
        const dom = `<input type="radio" id="${id}" class="card card-resource" name="resource-cards" value="${resourceCard}">`;
        $(this).replaceWith(dom);
      });
    };

    const renderProjectCardCheckbox = () => {
      // replace from static list
      $('li[name="project-cards"]').each(function (idx) {
        const projectCard = $(this).text();
        const id = `prj-${idx}`;
        const dom = `<div>
            <input type="checkbox" id="${id}" class="card card-project" name="project-cards" value="${projectCard}" />
            <label for="${id}">${projectCard}</label>
          </div>`;
        $(this).replaceWith(dom);
      });

      // replace from radio
      $('input[name="project-cards"][type="radio"]').each(function (idx) {
        const projectCard = $(this).val();
        const id = `prj-${idx}`;
        const dom = `<input type="checkbox" id="${id}" class="card card-project" name="project-cards" value="${projectCard}">`;
        $(this).replaceWith(dom);
      });
    };

    const renderResourceCardCheckbox = () => {
      // replace from static list
      $('li[name="resource-cards"]').each(function (idx) {
        const resourceCard = $(this).text();
        const id = `res-${idx}`;
        const dom = `<div>
            <input type="checkbox" id="${id}" class="card card-resource" name="resource-cards" value="${resourceCard}" />
            <label for="${id}">${resourceCard}</label>
          </div>`;
        $(this).replaceWith(dom);
      });

      // replace from radio
      $('input[name="resource-cards"][type="radio"]').each(function (idx) {
        const resourceCard = $(this).val();
        const id = `res-${idx}`;
        const dom = `<input type="checkbox" id="${id}" class="card card-resource" name="resource-cards" value="${resourceCard}">`;
        $(this).replaceWith(dom);
      });
    };

    const renderProjectCardStatic = () => {
      $('input[name="project-cards"]').each(function (idx) {
        const projectCard = $(this).val();
        const id = `prj-${idx}`;
        const dom = `<li id="${id}" name="project-cards">${projectCard}</li>`;
        $(this).parent().replaceWith(dom);
      });
    };

    const renderResourceCardStatic = () => {
      $('input[name="resource-cards"]').each(function (idx) {
        const resourceCard = $(this).val();
        const id = `res-${idx}`;
        const dom = `<li id="${id}" name="resource-cards">${resourceCard}</li>`;
        $(this).parent().replaceWith(dom);
      });
    };

    const gotoSubMenu = (element) => {
      $('button[id^="menu__"]').each(function () {
        $(this).prop('disabled', false).removeClass('action');
      });
      clearActionBar();
      $(element).prop('disabled', true).addClass('action');
    };

    const gotoMainMenu = () => {
      $('button[id^="menu__"]').each(function () {
        $(this).prop('disabled', false).removeClass('action');
      });
      clearActionBar();
    };

    function menuRecruit() {
      gotoSubMenu(this);

      renderProjectCardStatic();
      renderResourceCardRadio();
    }

    function menuCreateProject() {
      gotoSubMenu(this);
      const dom = $('<button id="create-project" class="action">create project</button>');
      dom.click(createProject);
      setActionBar(dom);

      renderProjectCardRadio();
      renderResourceCardRadio();
    }

    function menuContributeProject() {
      gotoSubMenu(this);

      renderProjectCardStatic();
      renderResourceCardStatic();
    }

    function menuPlayForceCard() {
      gotoSubMenu(this);

      renderProjectCardStatic();
      renderResourceCardRadio();
    }

    function menuDiscardAndEndTurn() {
      gotoSubMenu(this);
      const dom = $('<button id="discard-and-end-turn" class="action">discard and end turn</button>');
      dom.click(discardAndEndTurn);
      setActionBar(dom);

      renderProjectCardCheckbox();
      renderResourceCardCheckbox();
    }

    function actionCreator(element, successHandler, failureHandler) {
      removeError();
      showMessage('處理中...', element);
      // disable the button
      element.disabled = true;
      return google.script.run
        .withSuccessHandler(
          function (result, el) {
            removeMessage();
            // return main menu
            gotoMainMenu();
            if (successHandler) {
              successHandler(result, el);
            }
            el.disabled = false;
          })
        .withFailureHandler(
          function (error, el) {
            removeMessage();
            showError(error, el);
            if (failureHandler) {
              failureHandler(error, el);
            }
            el.disabled = false;
          })
        .withUserObject(element);
    }

    function createProject() {
      const action = actionCreator(this, showCards);
      const selectedProjectCard = $('input[name="project-cards"]:checked').val();
      const selectedResourceCard = $('input[name="resource-cards"]:checked').val();
      action.playProjectCard(selectedProjectCard, selectedResourceCard);
    }

    function discardAndEndTurn() {
      const action = actionCreator(this, showCards);
      const selectedProjectCards = $('input[name="project-cards"]:checked')
        .map((_, element) => element.value).get();
      const selectedResourceCards = $('input[name="resource-cards"]:checked')
        .map((_, element) => element.value).get();
      action.discardCardsAndEndTurn(selectedProjectCards, selectedResourceCards);
    }
  </script>
</head>

<body>
  <div class="sidebar">
    <h1>
      <?= player ?>的手牌
    </h1>
    <div>
      <button id="menu__recruit">招募人力<span>(1)</span></button>
      <button id="menu__create-project">發起專案<span>(2)</span></button>
      <button id="menu__contribute-project">貢獻專案<span>(1)</span></button>
    </div>
    <div>
      <button id="menu__play-force-card">源力加持<span>(1)</span></button>
      <button id="menu__discard-and-end-turn">棄牌後結束回合</button>
    </div>
    <form>
      <h2>專案卡</h2>
      <ul id="project-cards" class="form-group">Loading...</ul>
      <h2>資源卡</h2>
      <ul id="resource-cards" class="form-group">Loading...</ul>
      <div id="action-bar"></div>
    </form>
  </div>
</body>

</html>
